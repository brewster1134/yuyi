#!/usr/bin/env ruby

# THIS CODE INSPIRED BY (COPIED FROM) HOMEBREW'S INSTALL SCRIPT. THANKS! :)

def download_app
  Dir.chdir install_dir do
    # -m to stop tar erroring out if it can't modify the mtime for root owned directories
    # pipefail to cause the exit status from curl to propogate if it fails
    # we use -k for curl because Leopard has a bunch of bad SSL certificates
    curl_flags = 'fsSL'
    curl_flags << 'k' if macos_version <= '10.5'
    `/bin/bash -o pipefail -c '/usr/bin/curl -#{curl_flags} https://github.com/brewster1134/Yuyi/tarball/master | /usr/bin/tar xz -m --strip 1'`
  end
end

def install
  system "ruby #{install_dir}/bin/yuyi"
end

def cleanup
  `rm -rf #{install_dir}`
end

# Create the directory to download to and install from
def install_dir
  @install_dir ||= unless @install_dir
    `[ -d Yuyi ] || /bin/mkdir #{ENV['TMPDIR']}Yuyi`
    "#{ENV['TMPDIR']}Yuyi"
  end
end

# Get OSX minor version
def macos_version
  @macos_version ||= `/usr/bin/sw_vers -productVersion`.chomp[/10\.\d+/]
end

download_app
install
cleanup
